<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kalshi Manual Trade Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050814;
      --card-bg: #121826;
      --card-border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-danger: #f87171;
      --text-success: #4ade80;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --success-soft: rgba(74, 222, 128, 0.12);
      --input-bg: #020617;
      --input-border: #1e293b;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px 8px 48px;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 2px 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.1), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.08), transparent 50%),
                  var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 6px;
    }

    @media (max-width: 800px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.75));
      border-radius: 14px;
      padding: 10px 11px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .summary-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .summary-value.small {
      font-size: 0.95rem;
    }

    .summary-trend {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .summary-value.positive {
      color: var(--text-success);
    }

    .summary-value.negative {
      color: var(--text-danger);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.82rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      z-index: 1;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.65);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.4);
    }

    tbody tr:hover {
      background: rgba(55, 65, 81, 0.9);
    }

    .tag {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .tag-open {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .tag-closed {
      background: var(--success-soft);
      color: var(--text-success);
    }

    .tag-loss {
      background: var(--danger-soft);
      color: var(--text-danger);
    }

    .pl-pos {
      color: var(--text-success);
      font-weight: 500;
    }

    .pl-neg {
      color: var(--text-danger);
      font-weight: 500;
    }

    .muted {
      color: var(--text-muted);
    }

    .form-group {
      margin-bottom: 8px;
    }

    .form-label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 2px;
      color: var(--text-muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 0.82rem;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
      border-color: var(--accent);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #0b1120;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 4px;
    }

    .btn:hover {
      filter: brightness(1.08);
    }

    .helper-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .json-output-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Kalshi Manual Trade Log</h1>
        <p>Spreadsheet-style tracking stored in <strong>trade_log.json</strong> and rendered here.</p>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        <span id="updated-pill">Loading…</span>
      </div>
    </header>

    <!-- SUMMARY -->
    <section class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div>
          <div class="card-title">Portfolio Snapshot</div>
          <div class="card-subtitle">Derived from your manual log, not the Kalshi API.</div>
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Total Deposited</div>
          <div class="summary-value" id="sum-deposited">$0.00</div>
          <div class="summary-trend">All time cash in</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Realized P / L</div>
          <div class="summary-value" id="sum-realized">$0.00</div>
          <div class="summary-trend">Closed markets only</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Unrealized P / L</div>
          <div class="summary-value" id="sum-unrealized">$0.00</div>
          <div class="summary-trend">Estimate on open positions</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Lifetime ROI</div>
          <div class="summary-value small" id="sum-roi">0.0%</div>
          <div class="summary-trend">Total profit ÷ deposits</div>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- LEFT: TABLE -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Trade Log</div>
            <div class="card-subtitle">Looks like a spreadsheet; every row comes from <code>trade_log.json</code>.</div>
          </div>
        </div>

        <div style="max-height: 480px; overflow: auto; border-radius: 10px; border: 1px solid rgba(55,65,81,0.9);">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
                <th>Market / Contract</th>
                <th>Side</th>
                <th>Contracts</th>
                <th>Entry (¢)</th>
                <th>Exit/Now (¢)</th>
                <th>Cost ($)</th>
                <th>Payout ($)</th>
                <th>Fees ($)</th>
                <th>Net P/L ($)</th>
              </tr>
            </thead>
            <tbody id="trade-body">
              <!-- Filled by JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: FORM -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Add / Edit Trade</div>
            <div class="card-subtitle">Form for new rows. Paste the JSON into GitHub afterwards.</div>
          </div>
        </div>

        <form id="trade-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="f-date">Date</label>
              <input type="date" id="f-date" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="f-status">Status</label>
              <select id="f-status" required>
                <option value="OPEN">OPEN</option>
                <option value="CLOSED">CLOSED</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="f-market">Market</label>
            <input type="text" id="f-market" placeholder="Ohio St. at Michigan" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="f-contract">Contract / Leg</label>
              <input type="text" id="f-contract" placeholder="Yes - Michigan" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="f-side">Side</label>
              <select id="f-side">
                <option value="YES">YES</option>
                <option value="NO">NO</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="f-ticker">Ticker (optional)</label>
            <input type="text" id="f-ticker" placeholder="KXNCAAFGAME-25NOV29OSUMICH-MICH">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="f-contracts">Contracts</label>
              <input type="number" id="f-contracts" min="1" step="1" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="f-entry">Avg entry price (¢)</label>
              <input type="number" id="f-entry" step="0.01" placeholder="24" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="f-exit">Exit / current price (¢)</label>
              <input type="number" id="f-exit" step="0.01" placeholder="Leave blank for open; use current price for unrealized P/L">
            </div>
            <div class="form-group">
              <label class="form-label" for="f-cost">Total cost ($)</label>
              <input type="number" id="f-cost" step="0.01" placeholder="Optional – auto if blank">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="f-payout">Total payout ($) (closed only)</label>
              <input type="number" id="f-payout" step="0.01" placeholder="0 for full loss, or payout if right">
            </div>
            <div class="form-group">
              <label class="form-label" for="f-fees">Fees ($)</label>
              <input type="number" id="f-fees" step="0.01" placeholder="0.08" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="f-notes">Notes</label>
            <textarea id="f-notes" placeholder="Anything special about this trade…"></textarea>
          </div>

          <button type="submit" class="btn">Add / Update (local)</button>
          <div class="helper-text">
            This only updates the table in your browser. Copy the JSON below back into
            <code>frontend/data/trade_log.json</code> on GitHub and commit.
          </div>

          <div class="json-output-label">
            <span>Updated <code>trade_log.json</code> content</span>
            <span class="badge">Paste into GitHub</span>
          </div>
          <textarea id="json-output" readonly></textarea>
        </form>
      </section>
    </div>
  </div>

  <script>
    let tradeData = {
      meta: { last_updated: "", base_currency: "USD", total_deposited: 0 },
      trades: []
    };

    function fmtMoney(x) {
      if (isNaN(x)) return "$0.00";
      return "$" + x.toFixed(2);
    }

    function fmtPct(x) {
      if (!isFinite(x)) return "0.0%";
      return (x * 100).toFixed(1) + "%";
    }

    function computeNetPL(trade) {
      const cost = Number(trade.total_cost || 0);
      const fees = Number(trade.fees || 0);
      const payout = Number(trade.total_payout || 0);

      if (trade.status === "CLOSED") {
        return payout - cost - fees;
      }

      // OPEN: estimate using current price if present
      const entry = Number(trade.avg_entry_price_cents || 0);
      const curr = Number(trade.current_price_cents || entry);
      const contracts = Number(trade.contracts || 0);

      const estValue = contracts * (curr / 100);
      return estValue - cost - fees;
    }

    function render() {
      const tbody = document.getElementById("trade-body");
      tbody.innerHTML = "";

      let realized = 0;
      let unrealized = 0;

      for (const t of tradeData.trades) {
        const net = computeNetPL(t);
        if (t.status === "CLOSED") {
          realized += net;
        } else {
          unrealized += net;
        }

        const tr = document.createElement("tr");

        const exitOrNow = t.status === "CLOSED"
          ? (t.avg_exit_price_cents ?? "")
          : (t.current_price_cents ?? "");

        tr.innerHTML = `
          <td>${t.date || ""}</td>
          <td>
            <span class="tag ${
              t.status === "OPEN"
                ? "tag-open"
                : net < 0
                  ? "tag-loss"
                  : "tag-closed"
            }">${t.status}</span>
          </td>
          <td>
            <div>${t.market || ""}</div>
            <div class="muted">${t.contract || ""}</div>
          </td>
          <td>${t.side || ""}</td>
          <td>${t.contracts || ""}</td>
          <td>${t.avg_entry_price_cents ?? ""}</td>
          <td>${exitOrNow ?? ""}</td>
          <td>${fmtMoney(Number(t.total_cost || 0))}</td>
          <td>${fmtMoney(Number(t.total_payout || 0))}</td>
          <td>${fmtMoney(Number(t.fees || 0))}</td>
          <td class="${net >= 0 ? "pl-pos" : "pl-neg"}">${fmtMoney(net)}</td>
        `;

        tbody.appendChild(tr);
      }

      const deposited = Number(tradeData.meta.total_deposited || 0);
      const lifetime = realized + unrealized;

      document.getElementById("sum-deposited").textContent = fmtMoney(deposited);
      document.getElementById("sum-realized").textContent = fmtMoney(realized);
      document.getElementById("sum-unrealized").textContent = fmtMoney(unrealized);
      document.getElementById("sum-roi").textContent =
        deposited > 0 ? fmtPct(lifetime / deposited) : "0.0%";

      const updatedText = tradeData.meta.last_updated
        ? "Log last updated: " + tradeData.meta.last_updated
        : "Log loaded from trade_log.json";

      document.getElementById("updated-pill").textContent = updatedText;

      // Also keep JSON output in sync
      document.getElementById("json-output").value =
        JSON.stringify(tradeData, null, 2);
    }

    function handleFormSubmit(evt) {
      evt.preventDefault();

      const date = document.getElementById("f-date").value;
      const status = document.getElementById("f-status").value;
      const market = document.getElementById("f-market").value;
      const contract = document.getElementById("f-contract").value;
      const side = document.getElementById("f-side").value;
      const ticker = document.getElementById("f-ticker").value;

      const contracts = Number(document.getElementById("f-contracts").value);
      const entry = Number(document.getElementById("f-entry").value);
      const exit = document.getElementById("f-exit").value === ""
        ? null
        : Number(document.getElementById("f-exit").value);

      let cost = document.getElementById("f-cost").value === ""
        ? null
        : Number(document.getElementById("f-cost").value);
      const payout = document.getElementById("f-payout").value === ""
        ? 0
        : Number(document.getElementById("f-payout").value);
      const fees = Number(document.getElementById("f-fees").value);
      const notes = document.getElementById("f-notes").value;

      if (cost === null) {
        cost = contracts * (entry / 100);
      }

      const newId = (tradeData.trades.reduce((m, t) => Math.max(m, t.id || 0), 0) || 0) + 1;

      const trade = {
        id: newId,
        date,
        status,
        market,
        contract,
        side,
        ticker,
        contracts,
        avg_entry_price_cents: entry,
        total_cost: cost,
        fees,
        notes
      };

      if (status === "CLOSED") {
        trade.avg_exit_price_cents = exit !== null ? exit : null;
        trade.total_payout = payout;
      } else {
        if (exit !== null) {
          trade.current_price_cents = exit;
        }
      }

      tradeData.trades.push(trade);
      tradeData.meta.last_updated = new Date().toISOString();

      render();
    }

    document.getElementById("trade-form").addEventListener("submit", handleFormSubmit);

    // Load existing JSON
    fetch("data/trade_log.json", { cache: "no-store" })
      .then(r => r.ok ? r.json() : Promise.reject(new Error("HTTP " + r.status)))
      .then(data => {
        tradeData = data;
        render();
      })
      .catch(err => {
        console.error("Failed to load trade_log.json:", err);
        // Start with empty shell if file missing
        tradeData = {
          meta: { last_updated: "", base_currency: "USD", total_deposited: 0 },
          trades: []
        };
        render();
      });
  </script>
</body>
</html>
