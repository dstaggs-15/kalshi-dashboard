<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kalshi Portfolio Dashboard (Google Sheets)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --card-bg-inner: #0b1220;
      --border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --success: #4ade80;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.15);
      --success-soft: rgba(74, 222, 128, 0.15);
      --shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      --radius-lg: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      padding: 18px 10px 48px;
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
    }

    header p {
      margin: 0;
      font-size: 0.88rem;
      color: var(--text-muted);
    }

    .top-badges {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.35);
    }

    .headline-bar {
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .headline-metric {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 6px 12px;
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 0.86rem;
    }

    .headline-metric-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
    }

    .headline-metric-value {
      font-weight: 600;
    }

    .headline-metric-value.good {
      color: var(--success);
    }

    .headline-metric-value.bad {
      color: var(--danger);
    }

    .card {
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.9));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .summary-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .summary-card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(16,185,129,0.12), transparent 55%),
                  var(--card-bg-inner);
      border-radius: 14px;
      padding: 9px 11px;
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .summary-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .summary-value {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .summary-value.small {
      font-size: 0.94rem;
    }

    .summary-value.good { color: var(--success); }
    .summary-value.bad { color: var(--danger); }

    .summary-note {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .layout-two {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .layout-two { grid-template-columns: minmax(0,1fr); }
    }

    .table-wrapper {
      max-height: 460px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.9);
      overflow: auto;
      background: rgba(15,23,42,0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.98);
      z-index: 1;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(55,65,81,0.9);
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.7);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.45);
    }

    tbody tr:hover {
      background: rgba(55,65,81,0.95);
    }

    .tag {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    .tag-open {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .tag-closed {
      background: var(--success-soft);
      color: var(--success);
    }
    .tag-loss {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .pl-pos { color: var(--success); font-weight: 500; }
    .pl-neg { color: var(--danger); font-weight: 500; }

    .muted { color: var(--text-muted); }

    .explain-card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(55,65,81,0.85);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .explain-card h3 {
      margin: 0 0 6px;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .explain-card ul {
      margin: 4px 0 0;
      padding-left: 16px;
    }

    .explain-card li { margin-bottom: 2px; }

  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Kalshi Portfolio Dashboard</h1>
        <p>Simple view of how much you've put in, how much you've made, and what each game did – powered by Google Sheets.</p>
      </div>
      <div class="top-badges">
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="updated-pill">Loading data…</span>
        </div>
      </div>
    </header>

    <div class="headline-bar">
      <div class="headline-metric">
        <div class="headline-metric-label">Total Account Value (Sheet)</div>
        <div class="headline-metric-value" id="headline-total">$0.00</div>
      </div>
      <div class="headline-metric">
        <div class="headline-metric-label">Total Profit / Loss</div>
        <div class="headline-metric-value good" id="headline-pl">$0.00</div>
      </div>
    </div>

    <!-- SUMMARY CARDS -->
    <section class="card">
      <div class="card-title">At-a-Glance Summary</div>
      <div class="card-subtitle">Everything below comes from your Google Sheet – no Kalshi API weirdness, just exactly what you typed.</div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Money You Added</div>
          <div class="summary-value" id="sum-deposited">$0.00</div>
          <div class="summary-note">Total cash you've ever put in (manual setting in code).</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total Account Value</div>
          <div class="summary-value" id="sum-account">$0.00</div>
          <div class="summary-note">Deposits + all profits and losses from this sheet.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Closed Game Profit</div>
          <div class="summary-value" id="sum-realized">$0.00</div>
          <div class="summary-note">How much you've locked in from finished markets.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Open Game Profit (Estimate)</div>
          <div class="summary-value small" id="sum-unrealized">$0.00</div>
          <div class="summary-note">Rough P/L on bets still live right now.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total Fees Paid</div>
          <div class="summary-value small" id="sum-fees">$0.00</div>
          <div class="summary-note">All fees from this sheet added together.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Games Played</div>
          <div class="summary-value" id="sum-games">0</div>
          <div class="summary-note">Number of rows with a market name.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Win Rate (Closed)</div>
          <div class="summary-value small" id="sum-winrate">0.0%</div>
          <div class="summary-note">Closed rows where net P/L &gt; 0.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Lifetime Return</div>
          <div class="summary-value small" id="sum-roi">0.0%</div>
          <div class="summary-note">Total profit divided by money you added.</div>
        </div>
      </div>
    </section>

    <div class="layout-two">
      <!-- LEFT: TABLE / "SPREADSHEET" -->
      <section class="card">
        <div class="card-title">Game-by-Game Breakdown</div>
        <div class="card-subtitle">Each row is one market from your Google Sheet. Profit already accounts for fees.</div>

        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Date</th>
              <th>Status</th>
              <th>Market / Contract</th>
              <th>Side</th>
              <th>Contracts</th>
              <th>Entry (¢)</th>
              <th>Exit / Now (¢)</th>
              <th>Cost ($)</th>
              <th>Payout ($)</th>
              <th>Fees ($)</th>
              <th>Net P/L ($)</th>
            </tr>
            </thead>
            <tbody id="trade-body">
              <!-- rows filled by JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: EXPLANATION -->
      <section class="card">
        <div class="explain-card">
          <h3>How this dashboard works</h3>
          <ul>
            <li>You type trades into a Google Sheet (Date, Market, Contracts, Entry price, Exit price, Fees, etc.).</li>
            <li>The sheet is published as a read-only CSV link.</li>
            <li>This website downloads that CSV and does the math:
              <ul>
                <li><strong>Net P/L</strong> = payout − cost − fees</li>
                <li>Closed rows count as <strong>realized</strong> profit.</li>
                <li>Open rows use your “Exit / Current” price as a rough value to estimate <strong>unrealized</strong> profit.</li>
              </ul>
            </li>
            <li><strong>Total account value</strong> = money you added + all profit from this sheet.</li>
          </ul>
          <p style="margin-top:8px;">
            If numbers look wrong, 99% of the time it means a typo in the sheet:
            bad fee, wrong entry price, status not OPEN/CLOSED, etc.
          </p>
          <p style="margin-top:6px;">
            Edit the sheet, refresh this page, and everything updates.
          </p>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG: CHANGE THESE
    // ==========================
    // 1) Total cash you've ever deposited into Kalshi
    const TOTAL_DEPOSITED = 40; // <- update this when you add more money

    // 2) Google Sheets CSV URL (from "Publish to web" step)
    const SHEET_CSV_URL = "PASTE_YOUR_PUBLISHED_CSV_URL_HERE";

    // ==========================
    // HELPER FUNCTIONS
    // ==========================
    function fmtMoney(x) {
      if (isNaN(x)) return "$0.00";
      return "$" + x.toFixed(2);
    }

    function fmtPct(x) {
      if (!isFinite(x)) return "0.0%";
      return (x * 100).toFixed(1) + "%";
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];

      const headers = lines[0].split(",").map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const cells = line.split(",");
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = (cells[idx] || "").trim();
        });
        rows.push(row);
      }

      return rows;
    }

    function computeNetPL(trade) {
      const status = trade.Status || "OPEN";
      const contracts = Number(trade.Contracts || 0);
      const entryC = Number(trade.EntryCents || 0);
      const exitC = Number(trade.ExitOrCurrentCents || 0);
      let cost = trade.TotalCost === "" ? NaN : Number(trade.TotalCost);
      const payout = trade.TotalPayout === "" ? 0 : Number(trade.TotalPayout);
      const fees = trade.Fees === "" ? 0 : Number(trade.Fees);

      if (!isFinite(cost)) {
        cost = contracts * (entryC / 100);
      }

      if (status.toUpperCase() === "CLOSED") {
        return {
          cost,
          payout,
          fees,
          net: payout - cost - fees,
          estValue: payout
        };
      } else {
        const curr = exitC || entryC;
        const estValue = contracts * (curr / 100);
        return {
          cost,
          payout: 0,
          fees,
          net: estValue - cost - fees,
          estValue
        };
      }
    }

    // ==========================
    // RENDER
    // ==========================
    function renderDashboard(trades) {
      const tbody = document.getElementById("trade-body");
      tbody.innerHTML = "";

      let realized = 0;
      let unrealized = 0;
      let totalFees = 0;
      let games = 0;
      let closedGames = 0;
      let closedWins = 0;

      trades.forEach(trade => {
        const status = (trade.Status || "OPEN").toUpperCase();
        const result = computeNetPL(trade);
        const net = result.net;

        totalFees += result.fees;

        if (trade.Market) games++;

        if (status === "CLOSED") {
          realized += net;
          closedGames++;
          if (net > 0.0001) closedWins++;
        } else {
          unrealized += net;
        }

        const tr = document.createElement("tr");

        const exitOrNow = status === "CLOSED"
          ? (trade.ExitOrCurrentCents || "")
          : (trade.ExitOrCurrentCents || trade.EntryCents || "");

        tr.innerHTML = `
          <td>${trade.Date || ""}</td>
          <td>
            <span class="tag ${
              status === "OPEN"
                ? "tag-open"
                : net < 0
                  ? "tag-loss"
                  : "tag-closed"
            }">${status}</span>
          </td>
          <td>
            <div>${trade.Market || ""}</div>
            <div class="muted">${trade.Contract || ""}</div>
          </td>
          <td>${trade.Side || ""}</td>
          <td>${trade.Contracts || ""}</td>
          <td>${trade.EntryCents || ""}</td>
          <td>${exitOrNow}</td>
          <td>${fmtMoney(Number(result.cost || 0))}</td>
          <td>${fmtMoney(Number(result.payout || 0))}</td>
          <td>${fmtMoney(Number(result.fees || 0))}</td>
          <td class="${net >= 0 ? "pl-pos" : "pl-neg"}">${fmtMoney(net)}</td>
        `;
        tbody.appendChild(tr);
      });

      const totalProfit = realized + unrealized;
      const accountValue = TOTAL_DEPOSITED + totalProfit;
      const winRate = closedGames ? closedWins / closedGames : 0;

      document.getElementById("sum-deposited").textContent = fmtMoney(TOTAL_DEPOSITED);
      document.getElementById("sum-account").textContent = fmtMoney(accountValue);
      document.getElementById("sum-realized").textContent = fmtMoney(realized);
      document.getElementById("sum-unrealized").textContent = fmtMoney(unrealized);
      document.getElementById("sum-fees").textContent = fmtMoney(totalFees);
      document.getElementById("sum-games").textContent = games.toString();
      document.getElementById("sum-winrate").textContent = fmtPct(winRate);
      document.getElementById("sum-roi").textContent =
        TOTAL_DEPOSITED > 0 ? fmtPct(totalProfit / TOTAL_DEPOSITED) : "0.0%";

      const headlineTotal = document.getElementById("headline-total");
      const headlinePL = document.getElementById("headline-pl");

      headlineTotal.textContent = fmtMoney(accountValue);
      headlinePL.textContent = fmtMoney(totalProfit);
      headlinePL.classList.toggle("good", totalProfit >= 0);
      headlinePL.classList.toggle("bad", totalProfit < 0);

      const updated = new Date().toLocaleString();
      document.getElementById("updated-pill").textContent =
        `Sheet loaded · ${updated}`;
    }

    // ==========================
    // LOAD CSV FROM SHEET
    // ==========================
    fetch(SHEET_CSV_URL, { cache: "no-store" })
      .then(resp => {
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        return resp.text();
      })
      .then(text => {
        const rows = parseCsv(text);
        renderDashboard(rows);
      })
      .catch(err => {
        console.error("Error loading sheet:", err);
        document.getElementById("updated-pill").textContent =
          "Error loading Google Sheet – check CSV URL";
      });
  </script>
</body>
</html>
